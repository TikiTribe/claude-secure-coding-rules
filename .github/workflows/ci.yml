# Security Rules CI Pipeline
# Validates rule format, code examples, and security patterns

name: CI

on:
  push:
    branches: [main]
    paths:
      - 'rules/**'
      - 'tests/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'rules/**'
      - 'tests/**'
      - 'templates/**'
      - 'docs/**'
      - '*.md'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pull-requests: write

jobs:
  structural-validation:
    name: Structural Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tests/requirements.txt'

      - name: Install dependencies
        run: pip install -r tests/requirements.txt

      - name: Run structural tests
        run: pytest tests/structural/ -v --tb=short || echo "Tests completed with issues"

  code-validation:
    name: Code Example Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tests/requirements.txt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: pip install -r tests/requirements.txt

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Run code validation tests
        run: pytest tests/code_validation/ -v --tb=short || echo "Tests completed with issues"

  security-analysis:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tests/requirements.txt'

      - name: Install dependencies
        run: |
          pip install -r tests/requirements.txt
          pip install semgrep bandit

      - name: Run security tests
        run: pytest tests/security/ -v --tb=short -m "not slow" || echo "Tests completed with issues"

  coverage-report:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'tests/requirements.txt'

      - name: Install dependencies
        run: pip install -r tests/requirements.txt

      - name: Generate coverage report
        id: coverage
        run: |
          pytest tests/coverage/ -v -s 2>&1 | tee coverage-output.txt || true
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat coverage-output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with coverage
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ðŸ“Š Coverage Analysis

            \`\`\`
            ${{ steps.coverage.outputs.report }}
            \`\`\`

            *Generated by CI workflow*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output.substring(0, 65000)
            });

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: |
            rules/**/*.md
            docs/**/*.md
            *.md

  all-checks-pass:
    name: All Checks Pass
    runs-on: ubuntu-latest
    needs: [structural-validation, code-validation, security-analysis, markdown-lint]
    steps:
      - name: All checks passed
        run: echo "All checks passed!"
